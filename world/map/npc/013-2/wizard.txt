013-2.gat,66,39,0|script|Old Wizard#_W|116,
{
    set @has_magic, getskilllv(SKILL_MAGIC);
    set MAGIC_FLAGS, MAGIC_FLAGS | MFLAG_KNOWS_OLD_WIZARD;

//Bitmasks
    set @magicreset_MASK, NIBBLE_6_MASK;
    set @magicreset_SHIFT, NIBBLE_6_SHIFT;

    set @magicreset_state, ((QUEST_MAGIC2 & @magicreset_MASK) >> @magicreset_SHIFT);

//Bitmasks end

    if (@magicreset_state > 1)  goto L_WelcomeBack;

    mes "[Old Wizard]";
    mes "\"Welcome, dear wanderer! Come into my humble home. Take a rest, eat and drink.\"";
    next;
    menu
        "Thanks, that's very kind of you!", L_Thanks,
        "Can you teach me magic?", L_TeachRude,
        "Oh, shut up!", L_ShutUp;
    goto L_Close;

L_WelcomeBack:
    mes "[Old Wizard]";
    mes "\"Ah you're back. Do you want to talk about driving the dark out of you?\"";
    menu
        "No, I'm here to talk to you about magic", L_StarterMenu1,
        "Yes. Let's get on that", L_ContinuePathReset;
    goto L_Close;

L_ContinuePathReset:
    if (@magicreset_state == 1) goto L_BringItemsBranch;
    if (@magicreset_state == 2) goto L_BroughtItemsBranch;
    if (@magicreset_state == 3) goto L_InstructionsReviveTree;

L_StarterMenu1
    mes "[Old Wizard]";
    mes "\"Well then come into my humble home. Take a rest, eat and drink.\"";
    menu
        "Thanks, that's very kind of you!", L_Thanks,
        "Can you teach me magic?", L_TeachRude,
        "Oh, shut up!", L_ShutUp;

L_TeachRude:
    mes "[Old Wizard]";
    mes "\"I certainly could, but I already have an apprentice.\"";
    goto L_Close;

L_ShutUp:
    mes "[Old Wizard]";
    mes "\"That attitude isn't going to get you very far, my dear.\"";
    goto L_Close;

L_Thanks:
    mes "[Old Wizard]";
    mes "\"Behind this door, my apprentice will serve you.\"";
    next;
    if (getskilllv(SKILL_MAGIC_DARK) > 0)
        menu
            "Alright.",L_Agree,
            "I am studying magic, can you help?", L_NewStudent,
            "Your apprentice? ... No thanks.",L_Decline,
            "Do you if I could learn Astral Magic?" L_MagicPathReset;
    if (@has_magic)
        menu
            "Alright.", L_Agree,
            "I am studying magic, can you help?", L_NewStudent,
            "Your apprentice? ... No thanks.", L_Decline;
    if (!@has_magic)
        menu
            "Alright.", L_Agree,
            "Your apprentice? ... No thanks.", L_Decline;

L_Decline:
    mes "[Old Wizard]";
    mes "\"Goodbye, then!\"";
    goto L_Close;

L_NewStudent:
    mes "[Old Wizard]";
    mes "\"Studying is always an excellent use of one's mind! I fear that I can't offer too much assistance to you, however. But if you are interested, I could perhaps teach you a simple spell?\"";
    next;

    // check if the player has the knowledge of any skill
    if (!(getskilllv(SKILL_POOL)))
        menu
            "That would be very kind of you!", L_TeachSpell,
            "No, but thank you!", L_Decline;
    if (getskilllv(SKILL_POOL))
        menu
            "That would be very kind of you!", L_TeachSpell,
            "Actually I am looking for someone teaching me some more magic skills.", L_AstralSoul,
            "No, but thank you!", L_Decline;

L_TeachSpell:
    mes "[Old Wizard]";
    mes "\"This one may not seem too powerful, but it can be quite handy; it's the 'hide' spell. It will shield you from some forms of detection magic.\"";
    next;
    mes "[Old Wizard]";
    mes "\"Put a piece of cotton cloth on your head, and speak out '" + getspellinvocation("hide") + "', loudly and clearly. The protection lasts quite long, but you may have to renew it on occasion.\"";
    next;
    mes "[Old Wizard]";
    mes "\"You can also cast it on others, of course. Just speak their name after you pronounce the invocation.\"";
    next;
    mes "[Old Wizard]";
    mes "\"You may find it useful for getting a little peace and quiet at times, but it can also get in the way of friends trying to find you, so use it with care.\"";
    next;
    if (getskilllv(SKILL_MAGIC_ASTRAL) >= 2)
        goto L_Close;
    mes "[Old Wizard]";
    mes "\"I'm not sure if you are experienced enough to cast it yet, though.  You may need to first learn astral magic.\"";
    goto L_Close;

L_AstralSoul:
    mes "[Old Wizard]";
    mes "\"Oh yes, there are lots of ways to improve your magic. Skills -some people say mental focus for that- are another way to improve your magic. Of course learning more and more spells is also a need for good mages.\"";
    next;
    mes "\"I can teach you the ability to focus on magical stuff.\"";
    next;
    mes "\"To do so, I am in need of a pearl and about 100 acorns.\"";
    menu
        "Here we go.", -,
        "Ok be right back. I'll get them", L_Decline;
    if (countitem("Pearl") < 1 || countitem("Acorn") < 100) goto L_NotEnough;
    delitem "Pearl", 1;
    delitem "Acorn", 100;
    mes "[Old Wizard]";
    mes "\"Okay, listen:\"";
    next;
    mes "\"Some parts of your brain is still unused. These parts will now get the ability to get focused to magic.\"";
    next;
    mes "\"To do so, think of a magic spell!\"";
    next;
    mes "The old wizard mumbles some invocations";
    next;
    set @SUP_lvl, 1;
    set @SUP_id, SKILL_ASTRAL_SOUL;
    set @SUP_name$, "Astral Soul";
    set @SUP_xp, 2500;
    callfunc "SkillUp";
    mes "\"Now go and try to find someone who can actually activate that focus.\"";
    next;
    mes "\"You have the powers to focus on magic, but you need to get magic focused now.\"";
    goto L_Close;

L_NotEnough:
    mes "[Old Wizard]";
    mes "\"Please learn to count.\"";
    next;
    mes "\"When you are done with that, come back again.\"";
    goto L_Close;

L_Agree:
    mes "[Old Wizard]";
    mes "\"Beware the flying notes though, some of them are really dangerous. I haven't been able to persuade them to get back into their book. And avoid the mirror, it's been acting strange lately.\"";
    next;
    mes "\"Oh, and please don't take my apprentice too seriously. He still has a lot to learn.\"";
    goto L_Close;

L_Close:
    set @has_magic, 0;
    set @magicreset_MASK, 0;
    set @magicreset_SHIFT, 0;
    set @magicreset_state, 0;
    close;

L_MagicPathReset:
    if (@magicreset_state > 1) goto L_ContinuePathReset;
    mes "[Old Wizard]";
    mes "\"I see you are a Dark Mage.\"";
    mes "\"If you want to learn Astral Magic you have to undo the bad which you comitted to become a dark mage.\"";
    next;
    mes "\"What did you do?\"";
    menu
        "Nothing. I have no idea", L_ClueLess,
        "[Killed a sick Mouboo, Cut the Druid Tree.]", -;
    mes "\"I see.\"";
    mes "\"With proper ingredients and your remorse, undoing this should be achievable.\"";
    mes "\"Let's start by reviving the Druid Tree.\"";
    next;
    mes "The Wizard wanders mumbles something and a book flies into his hand. He starts reading";
    next;
    mes "[Old Wizard]";
    mes "\"Here! I found it.\"";
    next;
    mes "He appears to be excited";
    next;
    mes "[Old Wizard]";
    mes "\"Okay okay. Bring me two Pearls, one diseased heart, five Iron Powders and five Grass Seeds."\";
    mes "\"Bring me the branch of the tree which you cut off as well. Without this we can't get anything done"\";
    next;
    mes "\"With this ingredients we're going to revive a branch of the tree which will give the rest of the tree the lifeforce you took by cutting its branch.\"";
    mes "\"Come back when you got everything.\"";
    set @magicreset_state, 1;
    callsub S_Update_Mask;
    goto L_Close;

L_Clueless:
    mes "[Old Wizard]";
    mes "\"Well, I cannot help you undo something when you don't know what you have done.\"";
    mes "\"Come back when you know.\"";
    close;

L_BringItemsBranch:
    mes "[Old Wizard]";
    mes "\"Have you brought me two Pearls, one diseased heart, five Iron Powders five Grass Seeds and the branch of the tree?\"";
    menu
        "No. I don't have them with me", L_ComeBackLater,
        "Yes, here you are", -;
    if (countitem("DiseasedHeart") < 1)   goto L_NotEnough;
    if (countitem("Pearl") < 2)           goto L_NotEnough;
    if (countitem("IronPowder") < 5)      goto L_NotEnough;
    if (countitem("GrassSeed") < 5)       goto L_NotEnough;
    if (countitem("DruidTreeBranch") < 1) goto L_NotEnough;
    delitem "DiseasedHeart", 1;
    delitem "Pearl", 2;
    delitem "IronPowder", 5;
    delitem "GrassSeed", 5;
    delitem "DruidTreeBranch", 1;
    set @magicreset_state, 2;
    callsub S_Update_Mask;
    goto L_BroughtItemsBranch;

L_BroughtItemsBranch:
    mes "[Old Wizard]";
    mes "The wizard's eyes start gloating";
    mes "\"Ah all of those magical items at one place radiate an aura of pure strenght. This will be enough for me to revive this branch.\"";
    mes "He squashes the Heart and grinds it with a mortar. He then dries it with an akward heat spell. After that he grinds the pearls and puts all of the dust into a bowl.";
    next;
    mes "Then he pours in the iron powders and the Grass seeds, calls a spell and some very pure water comes out of his index finger. 23 drops of water drip into the bowl.";
    mes "After that he stirs the dust with the tree branch, while saying words you cannot understand.";
    next;
    mes "The branch appears to be absorbing the dust, once all of the dust is gone he looks at you.";
    next;
    mes "[Old Wizard]";
    mes "\"It is done! Take this branch and bring it to the tree. Stick it into the withering tree and the power the branch ingested will be given to the tree.\"";
    next;
    mes "\"After you did that pour some bottles of water on the tree. Do this slowly or else the power will be washed into the ground and will vanish.\"";
    mes "\"I am exhausted I have to rest now. Go and revive the tree.\"";
    getitem 905, 1;
    set @magicreset_state, 3;
    callsub S_Update_Mask;
    goto L_Close

L_InstructionsReviveTree:
    mes "[Old Wizard]";
    mes "\"Have you revived the tree yet?.\"";
    menu
        "Yes.", -,
        "No.", -;
    if (@magicreset_state > 5) goto L_RevivedTree;
    mes "[Old Wizard]";
    mes "\"What's up?\"";
    menu
        "I just didn't get there yet.", L_ComeBackLater,
        "I failed, the tree withered.", L_NewBranch;
        "I forgot what to do.", -;
    mes "[Old Wizard]";
    mes "\"Stick the branch into the withering tree and the power the branch ingested will be given to the tree.\"";
    mes "\"After you did that pour some bottles of water on the tree. Do this slowly or else the power will be washed into the ground and will vanish.\"";
    goto L_Close

L_NewBranch:
    mes "[Old Wizard]";
    mes "\"Do you want to make another vivid tree branch?\"";
    menu
        "Yes", -,
        "No", L_Close;
    mes "\"Okay. Bring me two Pearls, one diseased heart, five Iron Powders and five Grass Seeds and another branch of the tree.\"";
    menu
        "I'll be back with the stuff", L_Close,
        "Here you go.", -;
    if (countitem("DiseasedHeart") < 1)   goto L_NotEnough;
    if (countitem("Pearl") < 2)           goto L_NotEnough;
    if (countitem("IronPowder") < 5)      goto L_NotEnough;
    if (countitem("GrassSeed") < 5)       goto L_NotEnough;
    if (countitem("DruidTreeBranch") < 1) goto L_NoteNough;
    delitem "DiseasedHeart", 1;
    delitem "Pearl", 2;
    delitem "IronPowder", 5;
    delitem "GrassSeed", 5;
    delitem "DruidTreeBranch", 1;
    mes "The same ritual as before starts and the wizard hands you another vivid tree branch";
    getitem 905, 1;
    mes "[Old Wizard]";
    mes "\"Here you go. Now take better care of this one!\"";
    goto L_Close;

L_ComeBackLater:
    mes "[Old Wizard]";
    mes "\"Then come back later.\"";
    goto L_Close;

S_Update_Mask:
    set QUEST_MAGIC2,
        (QUEST_MAGIC2 & ~(@magicreset_MASK))
            | (@magicreset_state << @magicreset_SHIFT);
    return;
}
